# BIM AI Superintendent - Technical Documentation

## Table of Contents
1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Getting Started](#getting-started)
4. [Main Application](#main-application)
5. [Components](#components)
   - [Sidebar](#sidebar)
   - [DataView](#dataview)
   - [ReportView](#reportview)
   - [VoiceAssistant](#voiceassistant)
6. [Services](#services)
   - [API Service](#api-service)
   - [DeepSeek Service](#deepseek-service)
   - [Gemini Service](#gemini-service)
7. [Data Types](#data-types)
8. [Backend Integration](#backend-integration)

---

## Overview

**BIM AI Superintendent** is an AI-powered construction control application that compares Building Information Modeling (BIM) data with real-world 3D scan point clouds to track construction progress. It provides:

- **Digital Twin Visualization**: Interactive 3D viewer showing BIM objects and scanned point clouds
- **Progress Analysis**: Automatic comparison between planned (IFC) and executed (PLY) construction elements
- **AI-Powered Reports**: Executive reports generated by DeepSeek AI
- **Multimodal Assistant**: Voice (Gemini) and text (DeepSeek) chat for construction queries

### Technology Stack

| Category | Technologies |
|----------|--------------|
| Frontend | React 18, TypeScript, Vite |
| 3D Rendering | Three.js, React Three Fiber, React Three Drei |
| Charts | Recharts |
| Styling | TailwindCSS (via CDN) |
| AI Services | Google Gemini API, DeepSeek (via backend) |
| Icons | Lucide React |

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         BIM AI Superintendent                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐  ┌─────────────────────────────────────────┐  │
│  │   Sidebar    │  │              Main Content               │  │
│  │              │  │                                         │  │
│  │ • IFC Upload │  │  ┌───────────────────────────────────┐ │  │
│  │ • PLY Upload │  │  │  Tab Navigation                   │ │  │
│  │ • CSV Upload │  │  │  [Vistoria] [Relatório] [Voice]   │ │  │
│  │ • Floor Pick │  │  └───────────────────────────────────┘ │  │
│  │ • Process    │  │                                         │  │
│  │              │  │  ┌───────────────────────────────────┐ │  │
│  └──────────────┘  │  │  DataView / ReportView /          │ │  │
│                    │  │  VoiceAssistant                   │ │  │
│                    │  └───────────────────────────────────┘ │  │
│                    └─────────────────────────────────────────┘  │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
         ┌────────────────────────────────────────┐
         │         Backend APIs                    │
         │  • BIM Analyzer (Cloud Run)            │
         │  • DeepSeek AI (via proxy)             │
         │  • Gemini AI (direct)                  │
         └────────────────────────────────────────┘
```

---

## Getting Started

### Prerequisites
- Node.js (v18 or higher recommended)
- Gemini API Key

### Installation

```bash
# 1. Install dependencies
npm install

# 2. Configure API key in .env.local
GEMINI_API_KEY=your_api_key_here

# 3. Run development server
npm run dev
```

### Available Scripts

| Command | Description |
|---------|-------------|
| `npm run dev` | Start development server |
| `npm run build` | Build for production |
| `npm run preview` | Preview production build |

---

## Main Application

### `App.tsx`

The main application component that orchestrates the entire UI and state management.

#### State Management

```typescript
// Application Navigation State
const [activeTab, setActiveTab] = useState<AppTab>(AppTab.VISTORIA);
const [isProcessing, setIsProcessing] = useState(false);

// Data State
const [floors, setFloors] = useState<Floor[]>([]);
const [selectedFloorId, setSelectedFloorId] = useState<string>('');
const [analysisResult, setAnalysisResult] = useState<AnalysisResult | null>(null);

// File State
const [ifcFile, setIfcFile] = useState<File | null>(null);
const [plyFile, setPlyFile] = useState<File | null>(null);
const [csvFile, setCsvFile] = useState<File | null>(null);
const [csvContent, setCsvContent] = useState<string | null>(null);
```

#### Key Functions

| Function | Description |
|----------|-------------|
| `handleIfcUpload(file)` | Handles IFC file upload and automatically triggers floor listing from the backend |
| `handlePlyUpload(file)` | Stores the PLY point cloud file for analysis |
| `handleCsvUpload(file)` | Reads and stores CSV schedule content for AI comparison |
| `handleProcess()` | Triggers the floor analysis by sending IFC + PLY to the backend |

#### Tabs (Navigation)

| Tab | Enum Value | Description |
|-----|------------|-------------|
| Vistoria & Dados | `AppTab.VISTORIA` | 3D viewer with KPI dashboard |
| Relatório Executivo | `AppTab.RELATORIO` | AI-generated executive report |
| Fale com a Obra | `AppTab.VOICE` | Voice and text chat assistant |

---

## Components

### Sidebar

**File:** `components/Sidebar.tsx`

The left navigation panel with file upload controls and floor selection.

#### Props

```typescript
interface SidebarProps {
  floors: Floor[];           // List of available floors from IFC
  selectedFloor: string;     // Currently selected floor ID
  onFloorChange: (id: string) => void;
  onIfcUpload: (file: File) => void;
  onPlyUpload: (file: File) => void;
  onCsvUpload: (file: File) => void;
  onProcess: () => void;     // Trigger analysis
  isProcessing: boolean;     // Loading state
  hasIfc: boolean;           // IFC file uploaded flag
  hasPly: boolean;           // PLY file uploaded flag
}
```

#### Features

1. **API Status Indicator**: Shows system API key is active
2. **BIM Model Upload (.ifc)**: Accepts IFC files
3. **Point Cloud Upload (.ply)**: Accepts PLY files from 3D scanners
4. **Floor Selection**: Dropdown populated after IFC upload
5. **Schedule Upload (.csv)**: Optional CSV file for planned vs actual comparison
6. **Process Button**: Disabled until IFC + PLY + Floor are selected

---

### DataView

**File:** `components/DataView.tsx`

The main digital twin visualization component with 3D viewer and analytics.

#### Props

```typescript
interface DataViewProps {
  result: AnalysisResult | null;  // Analysis data from backend
}
```

#### Sub-Components

##### `ObjectPoints`
Loads and renders point cloud data from JSON files.

```typescript
const ObjectPoints = ({ jsonFile, color }: { jsonFile: string; color: string }) => {
  // Fetches point positions from backend output URL
  // Renders as Three.js Points with PointsMaterial
}
```

##### `DynamicVerticalGrid`
Interactive vertical grid overlay for height measurements.

```typescript
interface VerticalGridProps {
  position: THREE.Vector3;   // Current position
  visible: boolean;          // Toggle visibility
  gridCellSize?: number;     // Grid cell size (default: 1m)
  height?: number;           // Maximum height (default: 10m)
}
```

**Features:**
- XY plane grid (blue)
- ZY plane grid (green)
- Height markers every 1 meter
- Quadrant coordinate display (X, Z)
- Snaps to floor grid cells

##### `MeasureTool`
Interactive measurement tool for the 3D scene.

**Keyboard Controls:**

| Key | Action |
|-----|--------|
| `SPACE` | Toggle measurement mode ON/OFF |
| `A` / Arrow Left/Right | Lock to X axis (red) |
| `W` / Arrow Up | Lock to Y axis (green/vertical) |
| `S` / Arrow Down | Lock to Z axis (blue) |
| `R` | Free mode (no axis lock) |
| `G` | Toggle vertical grid |
| `ESC` | Cancel current measurement |
| Right-click | Anchor vertical grid to position |

**Interaction Flow:**
1. Press SPACE to enable measurement mode
2. Click and drag to measure between two points
3. Use axis keys (A/W/S) to constrain measurement
4. Distance displayed in meters with 3 decimal precision

##### `FixedScaleMarker`
Camera-distance-aware marker spheres for measurement points.

```typescript
const FixedScaleMarker = ({ position, color }) => {
  // Maintains constant visual size regardless of camera distance
  // Scale = distance * 0.015
}
```

##### `BimBoundingBox`
Renders wireframe bounding boxes for BIM elements.

```typescript
const BimBoundingBox = ({ item }) => {
  // Extracts bbox_normalized from item
  // Renders colored wireframe based on status
}
```

#### Main UI Layout

1. **3D Viewer (Left - 60%)**
   - Three.js Canvas with OrbitControls
   - Grid floor (20x20 units)
   - Axes helper (XYZ)
   - BIM bounding boxes
   - Point clouds per object
   - Measurement tool overlay

2. **KPI Cards (Right - 40%)**
   - Progress percentage
   - Executed vs Total elements

3. **Bar Chart**
   - Progress by element type (Wall, Slab, Column, etc.)
   - Stacked: Total, Complete, Partial

4. **Objects Table (Bottom)**
   - Filterable by status (Complete/Partial/Started/Absent)
   - Per-row visibility toggle (eye icon)
   - Columns: Name, Type, Status, Coverage %, Height (Exec/Plan)

#### Visibility System

```typescript
const [hiddenCategories, setHiddenCategories] = useState<Set<string>>(new Set());
const [hiddenItems, setHiddenItems] = useState<Set<string>>(new Set());
const [forcedVisibleItems, setForcedVisibleItems] = useState<Set<string>>(new Set());

// Check visibility logic
const isItemVisible = (item) => {
  if (forcedVisibleItems.has(guid)) return true;
  if (hiddenCategories.has(status)) return false;
  if (hiddenItems.has(guid)) return false;
  return true;
};
```

---

### ReportView

**File:** `components/ReportView.tsx`

AI-generated executive report using DeepSeek.

#### Props

```typescript
interface ReportViewProps {
  result: AnalysisResult | null;
  csvContent: string | null;  // Optional schedule for comparison
}
```

#### Features

1. **Generate Report Button**: Triggers AI analysis
2. **Loading State**: Spinning animation while processing
3. **Markdown Rendering**: Uses `react-markdown` for formatted output
4. **Regenerate**: Can regenerate report with updated data

#### Report Contents (AI-Generated)

- Progress summary (Real vs Planned)
- Categories with major delays
- 3 immediate corrective actions
- Risk assessment
- Professional markdown formatting

---

### VoiceAssistant

**File:** `components/VoiceAssistant.tsx`

Multimodal chat interface supporting voice (Gemini) and text (DeepSeek).

#### Props

```typescript
interface VoiceAssistantProps {
  result: AnalysisResult | null;
  csvContent: string | null;
}
```

#### State

```typescript
const [isRecording, setIsRecording] = useState(false);
const [messages, setMessages] = useState<ChatMessage[]>([]);
const [isProcessing, setIsProcessing] = useState(false);
const [textInput, setTextInput] = useState('');
```

#### Functions

| Function | Description |
|----------|-------------|
| `startRecording()` | Requests microphone permission and starts MediaRecorder |
| `stopRecording()` | Stops recording and triggers audio processing |
| `handleAudioProcess(audioBlob)` | Converts audio to Base64 and sends to Gemini |
| `handleTextSubmit()` | Sends text query to DeepSeek via backend |

#### Voice Recording Flow

```
User clicks mic → getUserMedia → MediaRecorder.start()
                                      ↓
User clicks stop → MediaRecorder.stop() → ondataavailable
                                              ↓
                     audioBlob → FileReader → Base64
                                              ↓
                     processVoiceQuery(base64, result, csvContent)
                                              ↓
                               Gemini API → Response text
```

#### UI Elements

1. **Message History**: Chat bubbles (user right, AI left)
2. **Text Input**: Type and send queries
3. **Voice Button**: Record audio messages
4. **Processing Indicator**: "Listening and analyzing..."

---

## Services

### API Service

**File:** `services/api.ts`

Backend communication for BIM analysis.

#### Configuration

```typescript
const API_BASE_URL = 'https://bim-analyzer-backend-277667971046.us-central1.run.app';
```

#### Functions

##### `listFloors(ifcFile: File): Promise<Floor[]>`

Lists all floors/levels in an IFC file.

**Request:**
- Method: `POST`
- Endpoint: `/api/listar_pavimentos`
- Body: `FormData` with `ifc_file`

**Response:**
```json
{
  "pavimentos": ["Térreo", "1º Pavimento", "2º Pavimento"]
}
```

##### `analyzeFloor(ifcFile, plyFile, floorId): Promise<AnalysisResult>`

Analyzes construction progress for a specific floor.

**Request:**
- Method: `POST`
- Endpoint: `/api/analisar_pavimento`
- Body: `FormData` with `ifc_file`, `ply_file`, `pavimento`

**Response Processing:**
```typescript
// Extracts items from response
const items: BimItem[] = json.resultados || [];

// Calculates statistics
const total = items.length;
const executed = items.filter(i => 
  i.status.code === 'COMPLETO' || i.status.code === 'PARCIAL'
).length;

// Categorizes by type
items.forEach(i => {
  if (!categories[i.tipo]) categories[i.tipo] = { total: 0, executed: 0 };
  categories[i.tipo].total++;
  // ...
});
```

---

### DeepSeek Service

**File:** `services/deepseek.ts`

AI services via backend proxy (for text chat and reports).

#### Configuration

```typescript
const BACKEND_URL = "https://bim-analyzer-backend-277667971046.us-central1.run.app";
```

#### Functions

##### `generateExecutiveReport(analysis, csvContent): Promise<string>`

Generates an executive report using DeepSeek AI.

**Request:**
- Method: `POST`
- Endpoint: `/api/generate_report`
- Body: `{ prompt: string }`

**Prompt Template:**
```
Atue como um Engenheiro Sênior de Planejamento e Controle de Obras.
Gere um relatório executivo conciso focado em riscos e desvios.

RESUMO DO PROGRESSO FÍSICO (REAL - Via Scanner 3D/IFC):
{statistics JSON}

AMOSTRA DE ITENS INDIVIDUAIS (TOP 20):
{items JSON}

DADOS DO PLANEJAMENTO (CRONOGRAMA CSV):
{CSV content or "não fornecido"}

Diretrizes:
1. Compare o realizado vs planejado (se disponível).
2. Destaque categorias com maior atraso.
3. Sugira 3 ações corretivas imediatas.
4. Use formatação Markdown profissional.
5. Seja direto e objetivo, máximo 500 palavras.
```

##### `processChatQuery(question, analysis, csvContent): Promise<string>`

Handles text-based chat queries.

**Request:**
- Method: `POST`
- Endpoint: `/api/chat`
- Body: `{ prompt: string }`

**System Prompt:**
```
Você é o "BIM Superintendent AI", um assistente técnico de obra.
Responda à pergunta do engenheiro com base ESTRITAMENTE nos dados fornecidos.
Se a resposta não estiver nos dados, diga que não sabe.
Seja curto, direto e técnico (máximo 200 palavras).
```

---

### Gemini Service

**File:** `services/gemini.ts`

Direct Google Gemini API integration for voice and advanced AI features.

#### Configuration

```typescript
const getClient = () => {
  const apiKey = process.env.API_KEY || "YOUR_FALLBACK_KEY";
  return new GoogleGenAI({ apiKey });
};

const model = "gemini-2.5-flash";
```

#### Functions

##### `generateExecutiveReport(analysis, csvContent): Promise<string>`

Alternative report generation using Gemini (same purpose as DeepSeek version).

##### `processVoiceQuery(audioBase64, analysis, csvContent): Promise<string>`

Processes voice queries using Gemini's multimodal capabilities.

**Request Structure:**
```typescript
contents: {
  parts: [
    {
      inlineData: {
        mimeType: "audio/webm",
        data: audioBase64,  // Base64 encoded audio
      },
    },
    {
      text: `${systemPrompt}\n\n${contextData}\n\nResponda ao áudio:`,
    },
  ],
}
```

##### `processChatQuery(question, analysis, csvContent): Promise<string>`

Text chat using Gemini (similar to DeepSeek version).

---

## Data Types

**File:** `types.ts`

### Enums

```typescript
export enum AppTab {
  VISTORIA = 'vistoria',    // Digital Twin & KPIs
  RELATORIO = 'relatorio',  // Executive Report
  VOICE = 'voice'           // Voice Assistant
}
```

### Interfaces

#### `Floor`
```typescript
export interface Floor {
  id: string;    // Floor identifier (e.g., "Térreo")
  name: string;  // Display name
}
```

#### `BBox` (Bounding Box)
```typescript
export interface BBox {
  xmin: number;
  xmax: number;
  ymin: number;
  ymax: number;
  zmin: number;
  zmax: number;
}
```

#### `BimItem`
```typescript
export interface BimItem {
  guid: string;               // Unique identifier
  nome: string;               // Display name
  tipo: string;               // IFC type (e.g., "IfcWall", "IfcColumn")
  pontos: number;             // Number of scan points matched
  cobertura_vertical: number; // Vertical coverage (0-1)
  status: {
    code: 'COMPLETO' | 'PARCIAL' | 'INICIADO' | 'AUSENTE';
    emoji: string;            // Status emoji
    texto: string;            // Status text
    cor: string;              // Status color (hex)
  };
  dimensoes: {
    progresso: { z: number }; // Height progress
  };
  json_file?: string;         // Point cloud JSON file path
  json_url?: string;          // Direct URL to points
  ply_file?: string;          // PLY file path
  bbox_normalized: BBox;      // Normalized bounding box
}
```

#### `AnalysisResult`
```typescript
export interface AnalysisResult {
  pavimento: string;          // Floor name
  session_id: string;         // Analysis session ID
  timestamp?: string;         // ISO timestamp
  estatisticas: {
    total: number;            // Total elements
    completos: number;        // Complete count
    parciais: number;         // Partial count
    iniciados: number;        // Started count
    ausentes: number;         // Absent count
    progresso_geral: number;  // Overall progress %
  };
  // Legacy compatibility
  summary?: {
    total_elements: number;
    executed_elements: number;
    progress_percentage: number;
    status_by_category?: Record<string, any>;
  };
  items?: BimItem[];          // Legacy field
  resultados: BimItem[];      // Primary items array
}
```

#### `ChatMessage`
```typescript
export interface ChatMessage {
  id: string;
  role: 'user' | 'model';
  text: string;
  timestamp: Date;
}
```

---

## Backend Integration

### API Endpoints Summary

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/listar_pavimentos` | POST | List floors from IFC |
| `/api/analisar_pavimento` | POST | Analyze floor progress |
| `/api/generate_report` | POST | Generate AI report (DeepSeek) |
| `/api/chat` | POST | Process chat query (DeepSeek) |
| `/outputs/{session_id}/{file}` | GET | Retrieve point cloud JSON |

### Backend URLs

| Version | URL |
|---------|-----|
| V1 | `https://bim-analyzer-backend-277667971046.us-central1.run.app` |
| V2 | `https://bim-api-v2-148459281394.us-central1.run.app/` |

### Error Handling

All API calls include error handling with user-friendly messages:

```typescript
try {
  const response = await fetch(/* ... */);
  if (!response.ok) {
    throw new Error(`API Error: ${response.status}`);
  }
  return await response.json();
} catch (error) {
  console.error("API Error:", error);
  // User-friendly fallback message
}
```

---

## File Structure

```
bim-ai-superintendent/
├── index.html              # Entry HTML with TailwindCSS
├── index.tsx               # React app bootstrap
├── App.tsx                 # Main application component
├── types.ts                # TypeScript interfaces
├── vite.config.ts          # Vite configuration
├── package.json            # Dependencies
├── .env.local              # Environment variables (API keys)
│
├── components/
│   ├── Sidebar.tsx         # File upload & floor selection
│   ├── DataView.tsx        # 3D viewer & analytics
│   ├── ReportView.tsx      # AI executive report
│   └── VoiceAssistant.tsx  # Voice/text chat
│
└── services/
    ├── api.ts              # Backend API calls
    ├── deepseek.ts         # DeepSeek AI integration
    └── gemini.ts           # Google Gemini integration
```

---

## License

This project is private and proprietary.

---

*Documentation generated for BIM AI Superintendent v0.0.0*
